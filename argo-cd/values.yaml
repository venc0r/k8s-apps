argo-cd:
  redis-ha:
    enabled: true

  controller:
    replicas: 1

  server:
    replicas: 2
    configEnabled: true
    config:
      sshConfigs: |
        Host argocd.ws.v3nc.org
            KexAlgorithms ecdh-sha2-nistp521
        Host argocd.k3s.v3nc.org
            KexAlgorithms ecdh-sha2-nistp521
      configManagementPlugins: |
        - name: kustomized-helm
          init:
            command: ["/bin/sh", "-c"]
            args: ["helm dependency build || true"]
          generate:
            command: ["/bin/sh", "-c"]
            args: ["helm template . --name-template $ARGOCD_APP_NAME --namespace $ARGOCD_APP_NAMESPACE -f values.yaml --include-crds > all.yaml && kustomize build"]
        - name: argocd-vault-plugin
          generate:
            command: ["argocd-vault-plugin"]
            args: ["generate", "./"]
        - name: argocd-vault-plugin-helm
          init:
            command: [sh, -c]
            args: ["helm dependency build"]
          generate:
            command: ["sh", "-c"]
            args: ["helm template $ARGOCD_APP_NAME --namespace $ARGOCD_APP_NAMESPACE ${helm_args} ${ARGOCD_ENV_PLUGIN_PARAMS} . --include-crds | argocd-vault-plugin generate -"]
        - name: argocd-vault-plugin-helm-kustomize
          init:
            command: [sh, -c]
            args: ["helm dependency build"]
          generate:
            command: ["sh", "-c"]
            args: ["helm template $ARGOCD_APP_NAME --namespace $ARGOCD_APP_NAMESPACE ${helm_args} ${ARGOCD_ENV_PLUGIN_PARAMS} . --include-crds > all.yaml && kustomize build | argocd-vault-plugin generate -"]

  repoServer:
    replicas: 2
    initContainers:
      - name: download-tools
        image: busybox:latest
        command: [sh, -c]
        env:
          - name: AVP_VERSION
            value: "1.12.0"
        args:
          - >-
            wget -O argocd-vault-plugin
            https://github.com/argoproj-labs/argocd-vault-plugin/releases/download/v${AVP_VERSION}/argocd-vault-plugin_${AVP_VERSION}_linux_amd64 &&
            chmod +x argocd-vault-plugin &&
            mv argocd-vault-plugin /custom-tools/
        volumeMounts:
          - mountPath: /custom-tools
            name: custom-tools
    volumes:
      - name: custom-tools
        emptyDir: {}
      - name: ssh-configs
        configMap:
          name: argocd-cm
          items:
            - key: sshConfigs
              path: config
    volumeMounts:
      - name: custom-tools
        mountPath: /usr/local/bin/argocd-vault-plugin
        subPath: argocd-vault-plugin
      - name: ssh-configs
        mountPath: /home/argocd/.ssh/
    envFrom:
      - secretRef:
          name: argocd-vault-plugin-credentials

    applicationSet:
      replicas: 2

